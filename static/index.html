<!DOCTYPE html>
<html>
<head>
    <title>Stock Analysis</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .form-group { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        input, select, button { padding: 8px; margin: 5px; }
        .loading { display: none; color: #666; font-weight: bold; }
        
        /* Tab styles */
        .tabs { margin: 20px 0; }
        .tab-buttons { border-bottom: 2px solid #ddd; }
        .tab-button { 
            background: none; 
            border: none; 
            padding: 12px 20px; 
            cursor: pointer; 
            border-bottom: 3px solid transparent;
            font-size: 16px;
            font-weight: bold;
        }
        .tab-button.active { 
            border-bottom-color: #007cba; 
            color: #007cba; 
        }
        .tab-button:hover { 
            background-color: #f0f0f0; 
        }
        .tab-button:disabled {
            color: #ccc;
            cursor: not-allowed;
        }
        .tab-button:disabled:hover {
            background-color: transparent;
        }
        
        .tab-content { 
            min-height: 400px; 
            padding: 20px 0; 
        }
        .tab-pane { 
            display: none; 
        }
        .tab-pane.active { 
            display: block; 
        }
        
        .chart { margin: 20px 0; text-align: center; }
        .stock-info { 
            background-color: #f8f9fa; 
            padding: 20px; 
            border-radius: 5px; 
            margin: 20px 0; 
        }
        .stock-info h2 { margin-top: 0; }
        .stock-metrics { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
        }
        .metric { 
            background: white; 
            padding: 10px; 
            border-radius: 3px; 
            border-left: 4px solid #007cba; 
        }
        
        #stockTable { margin-top: 20px; }
        
        /* News styles */
        .news-container { margin: 20px 0; }
        .news-article { 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            margin: 15px 0; 
            padding: 15px; 
            background-color: white;
            transition: box-shadow 0.3s ease;
        }
        .news-article:hover { 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        }
        .news-header { 
            display: flex; 
            align-items: flex-start; 
            gap: 15px; 
            margin-bottom: 10px; 
        }
        .news-thumbnail { 
            width: 80px; 
            height: 60px; 
            object-fit: cover; 
            border-radius: 3px; 
            flex-shrink: 0;
        }
        .news-content { flex: 1; }
        .news-title { 
            font-size: 16px; 
            font-weight: bold; 
            margin: 0 0 8px 0; 
            line-height: 1.4;
        }
        .news-title a { 
            text-decoration: none; 
            color: #333; 
        }
        .news-title a:hover { 
            color: #007cba; 
        }
        .news-meta { 
            font-size: 12px; 
            color: #666; 
            margin-bottom: 8px; 
        }
        .news-summary { 
            font-size: 14px; 
            color: #555; 
            line-height: 1.5; 
        }
        .no-news { 
            text-align: center; 
            color: #666; 
            padding: 40px; 
            font-style: italic; 
        }
        
        /* Comparison styles */
        .comparison-container { margin: 20px 0; }
        .comparison-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin: 20px 0; 
        }
        .stock-card { 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .stock-card h3 { 
            margin: 0 0 10px 0; 
            color: #333; 
            font-size: 18px; 
        }
        .stock-card .company-name { 
            font-size: 14px; 
            color: #666; 
            margin-bottom: 15px; 
        }
        .stock-metrics-compare { 
            display: grid; 
            gap: 10px; 
        }
        .metric-compare { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 0; 
            border-bottom: 1px solid #f0f0f0; 
        }
        .metric-compare:last-child { border-bottom: none; }
        .metric-label { font-weight: bold; color: #555; }
        .metric-value { color: #333; }
        .change-positive { color: #28a745; }
        .change-negative { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Stock Analysis Dashboard</h1>
        
        <div class="form-group">
            <label>Stock Symbol(s):</label>
            <input type="text" id="symbol" placeholder="e.g., AAPL or AAPL,MSFT,GOOGL" value="AAPL" style="width: 300px;">
            
            <label>Period:</label>
            <select id="period">
                <option value="1mo">1 Month</option>
                <option value="3mo" selected>3 Months</option>
                <option value="6mo">6 Months</option>
                <option value="1y">1 Year</option>
                <option value="2y">2 Years</option>
            </select>
            
            <button onclick="loadStockData()">Analyze Stocks</button>
        </div>
        
        <div class="loading" id="loading">Loading...</div>
        
        <div class="tabs" id="tabsContainer" style="display: none;">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="data">Stock Data</button>
                <button class="tab-button" data-tab="macd" disabled>MACD</button>
                <button class="tab-button" data-tab="rsi" disabled>RSI</button>
                <button class="tab-button" data-tab="correlation" disabled>Correlation</button>
                <button class="tab-button" data-tab="portfolio" disabled>Portfolio</button>
                <button class="tab-button" data-tab="volatility" disabled>Volatility</button>
                <button class="tab-button" data-tab="news" disabled>News</button>
            </div>
            
            <div class="tab-content">
                <div class="tab-pane active" id="data-tab">
                    <div id="stockInfo"></div>
                    <div id="dataTableContainer"></div>
                </div>
                
                <div class="tab-pane" id="macd-tab">
                    <div id="macdChart"></div>
                </div>
                
                <div class="tab-pane" id="rsi-tab">
                    <div id="rsiChart"></div>
                </div>
                
                <div class="tab-pane" id="correlation-tab">
                    <div id="correlationChart"></div>
                    <div id="correlationTable"></div>
                </div>
                
                <div class="tab-pane" id="portfolio-tab">
                    <div id="portfolioAnalysis"></div>
                    <div id="portfolioChart"></div>
                </div>
                
                <div class="tab-pane" id="volatility-tab">
                    <div id="volatilityChart"></div>
                    <div id="volatilityTable"></div>
                </div>
                
                <div class="tab-pane" id="news-tab">
                    <div id="newsContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStockData = null;
        let stockTable = null;
        
        function showLoading() {
            $('#loading').show();
        }
        
        function hideLoading() {
            $('#loading').hide();
        }
        
        function resetTabs() {
            // Hide tabs container
            $('#tabsContainer').hide();
            
            // Reset tab states
            $('.tab-button').removeClass('active').prop('disabled', true);
            $('.tab-button[data-tab="data"]').addClass('active').prop('disabled', false);
            $('.tab-pane').removeClass('active');
            $('#data-tab').addClass('active');
            
            // Clear content
            $('#stockInfo').empty();
            $('#dataTableContainer').empty();
            $('#comparisonResults').empty();
            $('#comparisonChart').empty();
            $('#macdChart').empty();
            $('#rsiChart').empty();
            $('#correlationChart').empty();
            $('#correlationTable').empty();
            $('#portfolioAnalysis').empty();
            $('#portfolioChart').empty();
            $('#volatilityChart').empty();
            $('#volatilityTable').empty();
            $('#newsContainer').empty();
            
            // Destroy existing DataTable if it exists
            if (stockTable) {
                stockTable.destroy();
                stockTable = null;
            }
        }
        
        function loadStockData() {
            const symbols = $('#symbol').val().trim();
            const period = $('#period').val();
            
            if (!symbols) {
                alert('Please enter stock symbol(s)');
                return;
            }
            
            // Reset everything when loading new stock
            resetTabs();
            showLoading();
            
            // Check if multiple symbols (contains comma)
            if (symbols.includes(',')) {
                // Multiple stocks - load comparison view
                loadMultipleStocks(symbols, period);
            } else {
                // Single stock - load individual view
                loadSingleStock(symbols, period);
            }
        }
        
        function loadSingleStock(symbol, period) {
            $.get(`/stock/${symbol}/${period}`)
                .done(function(data) {
                    currentStockData = data;
                    displayStockInfo(data.info);
                    displayDataTable(data.history);
                    
                    // Show tabs and enable all other tabs
                    $('#tabsContainer').show();
                    $('.tab-button[data-tab="macd"]').prop('disabled', false);
                    $('.tab-button[data-tab="rsi"]').prop('disabled', false);
                    $('.tab-button[data-tab="news"]').prop('disabled', false);
                })
                .fail(function() {
                    alert('Error loading stock data');
                })
                .always(function() {
                    hideLoading();
                });
        }
        
        function loadMultipleStocks(symbols, period) {
            // Clean up the symbols string - remove extra spaces
            const cleanSymbols = symbols.split(',').map(s => s.trim()).filter(s => s.length > 0).join(',');
            
            console.log('Loading comparison for symbols:', cleanSymbols);
            
            // Load comparison data first
            $.get(`/compare/${cleanSymbols}/${period}`)
                .done(function(data) {
                    console.log('Comparison data received:', data);
                    
                    // Display comparison cards
                    displayComparison(data.stocks);
                    
                    // Create comparison data table
                    displayComparisonTable(data.stocks);
                    
                    // Display general info about the comparison
                    displayComparisonInfo(data.stocks, data.period);
                    
                    // Now load the chart
                    $.get(`/compare/chart/${cleanSymbols}/${period}`)
                        .done(function(chartData) {
                            console.log('Chart data received:', chartData);
                            displayChart(chartData.chart, 'Stock Comparison', '#comparisonChart');
                        })
                        .fail(function(error) {
                            console.error('Chart loading error:', error);
                            $('#comparisonChart').html('<div class="no-news">Error loading comparison chart</div>');
                        });
                    
                    // Show tabs - enable multi-stock analysis tabs, disable single-stock tabs
                    $('#tabsContainer').show();
                    $('.tab-button[data-tab="macd"]').prop('disabled', true);
                    $('.tab-button[data-tab="rsi"]').prop('disabled', true);
                    $('.tab-button[data-tab="news"]').prop('disabled', true);
                    $('.tab-button[data-tab="correlation"]').prop('disabled', false);
                    $('.tab-button[data-tab="portfolio"]').prop('disabled', false);
                    $('.tab-button[data-tab="volatility"]').prop('disabled', false);
                })
                .fail(function(error) {
                    console.error('Comparison data error:', error);
                    alert('Error loading comparison data: ' + (error.responseJSON?.detail || error.statusText));
                })
                .always(function() {
                    hideLoading();
                });
        }
        
        function loadMACD() {
            const symbols = $('#symbol').val().trim();
            const period = $('#period').val();
            
            // Only allow MACD for single stock
            if (symbols.includes(',')) {
                alert('MACD analysis is only available for single stocks');
                return;
            }
            
            showLoading();
            
            $.get(`/macd/${symbols}/${period}`)
                .done(function(data) {
                    displayChart(data.chart, 'MACD Analysis', '#macdChart');
                })
                .fail(function() {
                    alert('Error loading MACD data');
                })
                .always(function() {
                    hideLoading();
                });
        }
        
        function loadRSI() {
            const symbols = $('#symbol').val().trim();
            const period = $('#period').val();
            
            // Only allow RSI for single stock
            if (symbols.includes(',')) {
                alert('RSI analysis is only available for single stocks');
                return;
            }
            
            showLoading();
            
            $.get(`/rsi/${symbols}/${period}`)
                .done(function(data) {
                    displayChart(data.chart, 'RSI Analysis', '#rsiChart');
                })
                .fail(function() {
                    alert('Error loading RSI data');
                })
                .always(function() {
                    hideLoading();
                });
        }
        
        function loadNews() {
            const symbols = $('#symbol').val().trim();
            
            // Only allow news for single stock
            if (symbols.includes(',')) {
                alert('News is only available for single stocks');
                return;
            }
            
            showLoading();
            
            $.get(`/news/${symbols}`)
                .done(function(data) {
                    displayNews(data.news);
                })
                .fail(function() {
                    alert('Error loading news data');
                })
                .always(function() {
                    hideLoading();
                });
        }
        
        function loadCorrelation() {
            const symbols = $('#symbol').val().trim();
            const period = $('#period').val();
            
            if (!symbols.includes(',')) {
                alert('Correlation analysis requires multiple stocks');
                return;
            }
            
            const cleanSymbols = symbols.split(',').map(s => s.trim()).filter(s => s.length > 0).join(',');
            
            showLoading();
            
            $.get(`/correlation/${cleanSymbols}/${period}`)
                .done(function(data) {
                    displayCorrelationAnalysis(data);
                })
                .fail(function(error) {
                    console.error('Correlation analysis error:', error);
                    $('#correlationChart').html('<div class="no-news">Error loading correlation analysis</div>');
                })
                .always(function() {
                    hideLoading();
                });
        }
        
        function loadPortfolio() {
            const symbols = $('#symbol').val().trim();
            const period = $('#period').val();
            
            if (!symbols.includes(',')) {
                alert('Portfolio analysis requires multiple stocks');
                return;
            }
            
            const cleanSymbols = symbols.split(',').map(s => s.trim()).filter(s => s.length > 0).join(',');
            
            showLoading();
            
            $.get(`/portfolio/${cleanSymbols}/${period}`)
                .done(function(data) {
                    displayPortfolioAnalysis(data);
                })
                .fail(function(error) {
                    console.error('Portfolio analysis error:', error);
                    $('#portfolioAnalysis').html('<div class="no-news">Error loading portfolio analysis</div>');
                })
                .always(function() {
                    hideLoading();
                });
        }
        
        function loadVolatility() {
            const symbols = $('#symbol').val().trim();
            const period = $('#period').val();
            
            if (!symbols.includes(',')) {
                alert('Volatility analysis requires multiple stocks');
                return;
            }
            
            const cleanSymbols = symbols.split(',').map(s => s.trim()).filter(s => s.length > 0).join(',');
            
            showLoading();
            
            $.get(`/volatility/${cleanSymbols}/${period}`)
                .done(function(data) {
                    displayVolatilityAnalysis(data);
                })
                .fail(function(error) {
                    console.error('Volatility analysis error:', error);
                    $('#volatilityChart').html('<div class="no-news">Error loading volatility analysis</div>');
                })
                .always(function() {
                    hideLoading();
                });
        }
        
        
        function displayComparison(stocks) {
            if (!stocks || stocks.length === 0) {
                $('#comparisonResults').html('<div class="no-news">No stock data available for comparison.</div>');
                return;
            }
            
            let html = '<div class="comparison-container"><h3>Stock Comparison</h3><div class="comparison-grid">';
            
            stocks.forEach(stock => {
                const changeClass = stock.change_percent >= 0 ? 'change-positive' : 'change-negative';
                const changeSign = stock.change_percent >= 0 ? '+' : '';
                
                html += `
                    <div class="stock-card">
                        <h3>${stock.symbol}</h3>
                        <div class="company-name">${stock.name}</div>
                        <div class="stock-metrics-compare">
                            <div class="metric-compare">
                                <span class="metric-label">Current Price</span>
                                <span class="metric-value">$${stock.current_price.toFixed(2)}</span>
                            </div>
                            <div class="metric-compare">
                                <span class="metric-label">Period Change</span>
                                <span class="metric-value ${changeClass}">${changeSign}${stock.change_percent.toFixed(2)}%</span>
                            </div>
                            <div class="metric-compare">
                                <span class="metric-label">Volume</span>
                                <span class="metric-value">${stock.volume.toLocaleString()}</span>
                            </div>
                            ${stock.market_cap ? `
                            <div class="metric-compare">
                                <span class="metric-label">Market Cap</span>
                                <span class="metric-value">$${(stock.market_cap / 1e9).toFixed(2)}B</span>
                            </div>
                            ` : ''}
                            ${stock.pe_ratio ? `
                            <div class="metric-compare">
                                <span class="metric-label">P/E Ratio</span>
                                <span class="metric-value">${stock.pe_ratio.toFixed(2)}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            $('#comparisonResults').html(html);
        }
        
        function displayComparisonInfo(stocks, period) {
            const stockNames = stocks.map(stock => `${stock.symbol} (${stock.name})`).join(', ');
            const html = `
                <div class="stock-info">
                    <h2>Stock Comparison Analysis</h2>
                    <div class="stock-metrics">
                        <div class="metric">
                            <strong>Stocks Compared</strong><br>
                            ${stockNames}
                        </div>
                        <div class="metric">
                            <strong>Analysis Period</strong><br>
                            ${period}
                        </div>
                        <div class="metric">
                            <strong>Total Stocks</strong><br>
                            ${stocks.length}
                        </div>
                        <div class="metric">
                            <strong>Best Performer</strong><br>
                            ${stocks.reduce((best, stock) => stock.change_percent > best.change_percent ? stock : best).symbol}
                            (${stocks.reduce((best, stock) => stock.change_percent > best.change_percent ? stock : best).change_percent.toFixed(2)}%)
                        </div>
                    </div>
                </div>
            `;
            $('#stockInfo').html(html);
        }
        
        function displayComparisonTable(stocks) {
            if (!stocks || stocks.length === 0) {
                $('#dataTableContainer').html('<div class="no-news">No stock data available for table.</div>');
                return;
            }
            
            // Get all unique dates from all stocks
            const allDates = new Set();
            stocks.forEach(stock => {
                stock.history.forEach(day => allDates.add(day.date));
            });
            
            const sortedDates = Array.from(allDates).sort().reverse(); // Most recent first
            
            const tableHtml = `
                <h3>Price History Comparison</h3>
                <table id="stockTable" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>Date</th>
                            ${stocks.map(stock => `<th>${stock.symbol} Price</th>`).join('')}
                            ${stocks.map(stock => `<th>${stock.symbol} Change %</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            `;
            
            $('#dataTableContainer').html(tableHtml);
            
            // Prepare data for DataTable
            const tableData = sortedDates.slice(0, 50).map(date => { // Limit to 50 most recent days
                const row = [date];
                
                // Add price columns
                stocks.forEach(stock => {
                    const dayData = stock.history.find(day => day.date === date);
                    row.push(dayData ? '$' + dayData.close.toFixed(2) : 'N/A');
                });
                
                // Add change % columns
                stocks.forEach(stock => {
                    const dayData = stock.history.find(day => day.date === date);
                    if (dayData) {
                        const changePercent = dayData.normalized;
                        const changeClass = changePercent >= 0 ? 'change-positive' : 'change-negative';
                        const changeSign = changePercent >= 0 ? '+' : '';
                        row.push(`<span class="${changeClass}">${changeSign}${changePercent.toFixed(2)}%</span>`);
                    } else {
                        row.push('N/A');
                    }
                });
                
                return row;
            });
            
            // Initialize DataTable
            stockTable = $('#stockTable').DataTable({
                data: tableData,
                order: [[0, 'desc']], // Sort by date descending
                pageLength: 25,
                responsive: true,
                columnDefs: [
                    { type: 'date', targets: 0 },
                    { className: 'text-right', targets: '_all' }
                ]
            });
        }
        
        function displayCorrelationAnalysis(data) {
            // Display correlation matrix
            if (data.correlation_matrix) {
                let html = '<div class="analysis-container"><h3>Correlation Analysis</h3>';
                html += '<p>Correlation measures how stocks move together. Values closer to 1 indicate positive correlation, -1 indicates negative correlation, and 0 indicates no correlation.</p>';
                html += '<table class="correlation-matrix" style="width: 100%; border-collapse: collapse; margin: 20px 0;">';
                
                const symbols = Object.keys(data.correlation_matrix);
                
                // Header row
                html += '<tr><th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5;"></th>';
                symbols.forEach(symbol => {
                    html += `<th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5;">${symbol}</th>`;
                });
                html += '</tr>';
                
                // Data rows
                symbols.forEach(symbol1 => {
                    html += `<tr><th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5;">${symbol1}</th>`;
                    symbols.forEach(symbol2 => {
                        const correlation = data.correlation_matrix[symbol1][symbol2];
                        const color = correlation > 0.7 ? '#28a745' : correlation < -0.7 ? '#dc3545' : '#6c757d';
                        html += `<td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: ${color}; font-weight: bold;">${correlation.toFixed(3)}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</table></div>';
                $('#correlationTable').html(html);
            }
            
            // Display correlation chart
            if (data.chart) {
                displayChart(data.chart, 'Correlation Heatmap', '#correlationChart');
            }
        }
        
        function displayPortfolioAnalysis(data) {
            let html = '<div class="analysis-container"><h3>Portfolio Analysis</h3>';
            
            if (data.portfolio_metrics) {
                html += '<div class="portfolio-metrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">';
                
                html += `
                    <div class="metric-card" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">Portfolio Return</h4>
                        <div style="font-size: 24px; font-weight: bold; color: ${data.portfolio_metrics.total_return >= 0 ? '#28a745' : '#dc3545'};">
                            ${data.portfolio_metrics.total_return >= 0 ? '+' : ''}${data.portfolio_metrics.total_return.toFixed(2)}%
                        </div>
                        <div style="font-size: 12px; color: #666;">Over ${data.period}</div>
                    </div>
                    
                    <div class="metric-card" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">Portfolio Volatility</h4>
                        <div style="font-size: 24px; font-weight: bold; color: #6c757d;">
                            ${data.portfolio_metrics.volatility.toFixed(2)}%
                        </div>
                        <div style="font-size: 12px; color: #666;">Annualized</div>
                    </div>
                    
                    <div class="metric-card" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">Sharpe Ratio</h4>
                        <div style="font-size: 24px; font-weight: bold; color: #007cba;">
                            ${data.portfolio_metrics.sharpe_ratio.toFixed(2)}
                        </div>
                        <div style="font-size: 12px; color: #666;">Risk-adjusted return</div>
                    </div>
                `;
                
                html += '</div>';
                
                // Best and worst performers
                if (data.portfolio_metrics.best_performer && data.portfolio_metrics.worst_performer) {
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">';
                    html += `
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
                            <h4 style="margin: 0 0 10px 0; color: #155724;">Best Performer</h4>
                            <div style="font-weight: bold;">${data.portfolio_metrics.best_performer.symbol}</div>
                            <div style="color: #28a745;">+${data.portfolio_metrics.best_performer.return.toFixed(2)}%</div>
                        </div>
                        
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f1b0b7;">
                            <h4 style="margin: 0 0 10px 0; color: #721c24;">Worst Performer</h4>
                            <div style="font-weight: bold;">${data.portfolio_metrics.worst_performer.symbol}</div>
                            <div style="color: #dc3545;">${data.portfolio_metrics.worst_performer.return.toFixed(2)}%</div>
                        </div>
                    `;
                    html += '</div>';
                }
            }
            
            html += '</div>';
            $('#portfolioAnalysis').html(html);
            
            // Display portfolio chart
            if (data.chart) {
                displayChart(data.chart, 'Portfolio Performance vs Individual Stocks', '#portfolioChart');
            }
        }
        
        function displayVolatilityAnalysis(data) {
            let html = '<div class="analysis-container"><h3>Volatility Analysis</h3>';
            html += '<p>Volatility measures the degree of price fluctuation. Higher volatility indicates more price swings and higher risk.</p>';
            
            if (data.volatility_metrics) {
                html += '<table style="width: 100%; border-collapse: collapse; margin: 20px 0;">';
                html += '<tr><th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5;">Symbol</th>';
                html += '<th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5;">Volatility (%)</th>';
                html += '<th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5;">Risk Level</th></tr>';
                
                data.volatility_metrics.forEach(stock => {
                    const riskLevel = stock.volatility > 30 ? 'High' : stock.volatility > 20 ? 'Medium' : 'Low';
                    const riskColor = stock.volatility > 30 ? '#dc3545' : stock.volatility > 20 ? '#ffc107' : '#28a745';
                    
                    html += `<tr>
                        <td style="border: 1px solid #ddd; padding: 12px; font-weight: bold;">${stock.symbol}</td>
                        <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">${stock.volatility.toFixed(2)}%</td>
                        <td style="border: 1px solid #ddd; padding: 12px; text-align: center; color: ${riskColor}; font-weight: bold;">${riskLevel}</td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            html += '</div>';
            $('#volatilityTable').html(html);
            
            // Display volatility chart
            if (data.chart) {
                displayChart(data.chart, 'Volatility Comparison', '#volatilityChart');
            }
        }
        
        function displayStockInfo(info) {
            const html = `
                <div class="stock-info">
                    <h2>${info.longName || info.shortName || 'N/A'} (${info.symbol})</h2>
                    <div class="stock-metrics">
                        <div class="metric">
                            <strong>Current Price</strong><br>
                            $${info.currentPrice || 'N/A'}
                        </div>
                        <div class="metric">
                            <strong>Market Cap</strong><br>
                            $${info.marketCap ? (info.marketCap / 1e9).toFixed(2) + 'B' : 'N/A'}
                        </div>
                        <div class="metric">
                            <strong>52 Week High</strong><br>
                            $${info.fiftyTwoWeekHigh || 'N/A'}
                        </div>
                        <div class="metric">
                            <strong>52 Week Low</strong><br>
                            $${info.fiftyTwoWeekLow || 'N/A'}
                        </div>
                    </div>
                </div>
            `;
            $('#stockInfo').html(html);
        }
        
        function displayChart(chartData, title, container) {
            const html = `
                <div class="chart">
                    <h3>${title}</h3>
                    <img src="data:image/png;base64,${chartData}" style="max-width: 100%;">
                </div>
            `;
            $(container).html(html);
        }
        
        function displayDataTable(history) {
            const tableHtml = `
                <h3>Price History</h3>
                <table id="stockTable" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Open</th>
                            <th>High</th>
                            <th>Low</th>
                            <th>Close</th>
                            <th>Volume</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            `;
            
            $('#dataTableContainer').html(tableHtml);
            
            // Prepare data for DataTable
            const tableData = history.map(row => [
                row.Date,
                '$' + row.Open.toFixed(2),
                '$' + row.High.toFixed(2),
                '$' + row.Low.toFixed(2),
                '$' + row.Close.toFixed(2),
                row.Volume.toLocaleString()
            ]);
            
            // Initialize DataTable
            stockTable = $('#stockTable').DataTable({
                data: tableData,
                order: [[0, 'desc']], // Sort by date descending (newest first)
                pageLength: 25,
                responsive: true,
                columnDefs: [
                    { type: 'date', targets: 0 },
                    { className: 'text-right', targets: [1, 2, 3, 4, 5] }
                ]
            });
        }
        
        function displayNews(newsArticles) {
            if (!newsArticles || newsArticles.length === 0) {
                $('#newsContainer').html('<div class="no-news">No recent news available for this stock.</div>');
                return;
            }
            
            let newsHtml = '<div class="news-container"><h3>Latest News</h3>';
            
            newsArticles.forEach(article => {
                const publishDate = article.publishTime ? new Date(article.publishTime * 1000).toLocaleDateString() : 'Unknown date';
                const thumbnail = article.thumbnail ? 
                    `<img src="${article.thumbnail}" alt="News thumbnail" class="news-thumbnail" onerror="this.style.display='none'">` : '';
                
                newsHtml += `
                    <div class="news-article">
                        <div class="news-header">
                            ${thumbnail}
                            <div class="news-content">
                                <h4 class="news-title">
                                    ${article.link ? `<a href="${article.link}" target="_blank">${article.title}</a>` : article.title}
                                </h4>
                                <div class="news-meta">
                                    ${article.publisher} â€¢ ${publishDate}
                                </div>
                            </div>
                        </div>
                        ${article.summary ? `<div class="news-summary">${article.summary}</div>` : ''}
                    </div>
                `;
            });
            
            newsHtml += '</div>';
            $('#newsContainer').html(newsHtml);
        }
        
        // Tab switching functionality
        $(document).ready(function() {
            $('.tab-button').click(function() {
                if ($(this).prop('disabled')) return;
                
                const targetTab = $(this).data('tab');
                
                // Update button states
                $('.tab-button').removeClass('active');
                $(this).addClass('active');
                
                // Update tab panes
                $('.tab-pane').removeClass('active');
                $(`#${targetTab}-tab`).addClass('active');
                
                // Load data for the specific tab if not already loaded
                if (targetTab === 'macd' && $('#macdChart').is(':empty')) {
                    loadMACD();
                } else if (targetTab === 'rsi' && $('#rsiChart').is(':empty')) {
                    loadRSI();
                } else if (targetTab === 'news' && $('#newsContainer').is(':empty')) {
                    loadNews();
                } else if (targetTab === 'correlation' && $('#correlationChart').is(':empty')) {
                    loadCorrelation();
                } else if (targetTab === 'portfolio' && $('#portfolioAnalysis').is(':empty')) {
                    loadPortfolio();
                } else if (targetTab === 'volatility' && $('#volatilityChart').is(':empty')) {
                    loadVolatility();
                }
            });
        });
    </script>
</body>
</html>